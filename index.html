<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Voos em Tempo Real - Vila de Rei</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    caption {
      font-size: 1.5em;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Voos num raio de 200 km de Vila de Rei</h1>
  <table>
    <caption>Aeronaves Ativas</caption>
    <thead>
      <tr>
        <th>ICAO24</th>
        <th>Chamada</th>
        <th>País Origem</th>
        <th>Última Pos.</th>
        <th>Última Atual.</th>
        <th>Longitude</th>
        <th>Latitude</th>
        <th>Altitude Bar. (m)</th>
        <th>No Solo</th>
        <th>Velocidade (m/s)</th>
        <th>Taxa Vertical (m/s)</th>
        <th>Transponder</th>
        <th>Pos. Source</th>
      </tr>
    </thead>
    <tbody id="flight-data">
      <tr><td colspan="13">A carregar dados...</td></tr>
    </tbody>
  </table>

  <script>
    async function fetchFlightData() {
      const lamin = 37.8761;
      const lamax = 41.4761;
      const lomin = -10.3272;
      const lomax = -5.9272;

      const url = `https://opensky-network.org/api/states/all?lamin=${lamin}&lamax=${lamax}&lomin=${lomin}&lomax=${lomax}`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        const tbody = document.getElementById('flight-data');
        tbody.innerHTML = '';

        if (!data.states || data.states.length === 0) {
          tbody.innerHTML = '<tr><td colspan="13">Nenhum voo encontrado na área.</td></tr>';
          return;
        }

        data.states.forEach(state => {
          const [
            icao24, callsign, origin_country, time_position, last_contact,
            longitude, latitude, baro_altitude, on_ground, velocity,
            vertical_rate, , , , , transponder_code, , position_source
          ] = state;

          const formatTime = ts => ts ? new Date(ts * 1000).toLocaleTimeString('pt-PT') : '—';

          const row = `
            <tr>
              <td>${icao24 || '—'}</td>
              <td>${callsign?.trim() || '—'}</td>
              <td>${origin_country || '—'}</td>
              <td>${formatTime(time_position)}</td>
              <td>${formatTime(last_contact)}</td>
              <td>${longitude?.toFixed(4) || '—'}</td>
              <td>${latitude?.toFixed(4) || '—'}</td>
              <td>${baro_altitude?.toFixed(2) || '—'}</td>
              <td>${on_ground}</td>
              <td>${velocity?.toFixed(2) || '—'}</td>
              <td>${vertical_rate?.toFixed(2) || '—'}</td>
              <td>${transponder_code || '—'}</td>
              <td>${position_source}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        document.getElementById('flight-data').innerHTML = '<tr><td colspan="13">Erro ao carregar dados.</td></tr>';
        console.error('Erro ao buscar dados da API:', error);
      }
    }

    fetchFlightData();
  </script>
</body>
</html>
