<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Voos em Tempo Real - Vila de Rei</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    caption {
      font-size: 1.5em;
      margin-bottom: 10px;
    }
    img.flag {
      width: 24px;
      height: 18px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <h1>Voos num raio de 200 km de Vila de Rei</h1>
  <p><em>Atualiza√ß√£o autom√°tica a cada 30 segundos</em></p>
  <table>
    <caption>Aeronaves Ativas</caption>
    <thead>
      <tr>
        <th>ICAO24</th>
        <th>Chamada</th>
        <th>Pa√≠s Origem</th>
        <th>√öltima Pos.</th>
        <th>√öltima Atual.</th>
        <th>Longitude</th>
        <th>Latitude</th>
        <th>Altitude Bar. (m)</th>
        <th>No Solo</th>
        <th>Velocidade (km/h)</th>
        <th>Taxa Vertical (km/h)</th>
        <th>Transponder</th>
        <th>Pos. Source</th>
      </tr>
    </thead>
    <tbody id="flight-data">
      <tr><td colspan="13">A carregar dados...</td></tr>
    </tbody>
  </table>

  <script>
    const lamin = 37.8761;
    const lamax = 41.4761;
    const lomin = -10.3272;
    const lomax = -5.9272;
    const url = `https://opensky-network.org/api/states/all?lamin=${lamin}&lamax=${lamax}&lomin=${lomin}&lomax=${lomax}`;

    function getFlagIcon(countryName) {
      if (!countryName) return `<span title="Desconhecido">üåê</span>`;
      const normalized = countryName.trim().toLowerCase();
      const aliases = {
        "usa": "us", "united states": "us", "uk": "gb", "united kingdom": "gb",
        "kingdom of the netherlands": "nl", "czech republic": "cz",
        "switzerland": "ch", "malta": "mt", "argentina": "ar"
      };
      const countryCodes = {
        "at": "Austria", "be": "Belgium", "bg": "Bulgaria", "hr": "Croatia",
        "cz": "Czech Republic", "fr": "France", "de": "Germany", "ie": "Ireland",
        "it": "Italy", "nl": "Netherlands", "pl": "Poland", "pt": "Portugal",
        "es": "Spain", "tr": "Turkey", "gb": "United Kingdom", "us": "United States",
        "ar": "Argentina", "mt": "Malta", "ch": "Switzerland"
      };
      const code = aliases[normalized] || Object.keys(countryCodes).find(
        key => countryCodes[key].toLowerCase() === normalized
      );
      if (!code) return `<span title="${countryName}">üåê</span>`;
      return `<img class="flag" src="https://flagcdn.com/24x18/${code}.png" alt="${countryName}" title="${countryName}">`;
    }

    function formatTime(ts) {
      return ts ? new Date(ts * 1000).toLocaleTimeString('pt-PT') : '‚Äî';
    }

    function toKmh(val) {
      return val != null ? (val * 3.6).toFixed(2) : '‚Äî';
    }

    function formatTransponder(code) {
      if (!/^[0-9]{4}$/.test(code)) return '‚Äî';
      const alerts = {
        "7500": "üî¥ Interfer√™ncia",
        "7600": "üü† Falha de r√°dio",
        "7700": "üü° Emerg√™ncia"
      };
      return alerts[code] ? `<span title="${alerts[code]}">${code}</span>` : code;
    }

    async function fetchFlightData() {
      try {
        const response = await fetch(url);
        const data = await response.json();
        const tbody = document.getElementById('flight-data');
        tbody.innerHTML = '';

        if (!data.states || data.states.length === 0) {
          tbody.innerHTML = '<tr><td colspan="13">Nenhum voo encontrado na √°rea.</td></tr>';
          return;
        }

        data.states.forEach(state => {
          const [
            icao24, callsign, origin_country, time_position, last_contact,
            longitude, latitude, baro_altitude, on_ground, velocity,
            vertical_rate, , , , , , , , , , , transponder_code, , position_source
          ] = state;

          const row = `
            <tr>
              <td>${icao24 || '‚Äî'}</td>
              <td>${callsign?.trim() || '‚Äî'}</td>
              <td>${getFlagIcon(origin_country)}</td>
              <td>${formatTime(time_position)}</td>
              <td>${formatTime(last_contact)}</td>
              <td>${longitude?.toFixed(4) || '‚Äî'}</td>
              <td>${latitude?.toFixed(4) || '‚Äî'}</td>
              <td>${baro_altitude?.toFixed(2) || '‚Äî'}</td>
              <td>${on_ground}</td>
              <td>${toKmh(velocity)}</td>
              <td>${toKmh(vertical_rate)}</td>
              <td>${formatTransponder(transponder_code)}</td>
              <td>${position_source}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        document.getElementById('flight-data').innerHTML = '<tr><td colspan="13">Erro ao carregar dados.</td></tr>';
        console.error('Erro ao buscar dados da API:', error);
      }
    }

    fetchFlightData();
    setInterval(fetchFlightData, 30000);
  </script>
</body>
</html>
