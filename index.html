<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Voos em Tempo Real - Vila de Rei</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    .table-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    caption {
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    img.flag {
      width: 24px;
      height: 18px;
      border-radius: 2px;
    }
    .callsign-label {
      background-color: rgba(255, 255, 255, 0.85);
      color: #000;
      font-weight: bold;
      font-size: 11px;
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-shadow: 0 0 2px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="map"></div>
    <div class="table-container">
      <h2>Voos num raio alargado de Vila de Rei</h2>
      <p><em>Atualiza√ß√£o autom√°tica a cada 30 segundos</em></p>
      <table>
        <caption>Aeronaves Ativas</caption>
        <thead>
          <tr>
            <th>ICAO24</th>
            <th>Chamada</th>
            <th>Pa√≠s Origem</th>
            <th>√öltima Pos.</th>
            <th>√öltima Atual.</th>
            <th>Altitude Bar. (m)</th>
            <th>Velocidade (km/h)</th>
            <th>Taxa Vertical (km/h)</th>
            <th>Transponder</th>
            <th>Pos. Source</th>
          </tr>
        </thead>
        <tbody id="flight-data">
          <tr><td colspan="10">A carregar dados...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const url = "https://opensky-network.org/api/states/all?lamin=36.0&lamax=43.0&lomin=-11.5&lomax=-5.0";
    let map;
    let markers = [];

    function initMap() {
      map = L.map('map').setView([39.6761, -8.1272], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    async function getCountryCode(name) {
      try {
        const res = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fullText=true`);
        const data = await res.json();
        return data[0]?.cca2?.toLowerCase() || null;
      } catch {
        return null;
      }
    }

    async function getFlagIcon(countryName) {
      const code = await getCountryCode(countryName);
      if (!code) return `<span title="${countryName}">üåê</span>`;
      return `<img class="flag" src="https://flagcdn.com/24x18/${code}.png" alt="${countryName}" title="${countryName}">`;
    }

    function formatTime(ts) {
      return ts ? new Date(ts * 1000).toLocaleTimeString('pt-PT') : '‚Äî';
    }

    function toKmh(val) {
      return val != null ? (val * 3.6).toFixed(2) : '‚Äî';
    }

    function formatTransponder(code) {
      if (!code || typeof code !== 'string') return '‚Äî';
      const alerts = {
        "7500": "üî¥ Interfer√™ncia",
        "7600": "üü† Falha de r√°dio",
        "7700": "üü° Emerg√™ncia"
      };
      return alerts[code] ? `<span title="${alerts[code]}">${code}</span>` : code;
    }

    function formatPositionSource(code) {
      const sources = {
        0: "ADS-B",
        1: "ASTERIX",
        2: "MLAT"
      };
      return sources[code] ?? "‚Äî";
    }

    function createDirectionIcon(heading, position_source) {
      const rotation = heading || 0;
      const lineColor = position_source === 2 ? 'lime' : 'red';
      const html = `
        <div style="transform: rotate(${rotation}deg); width: 32px; height: 32px;">
          <svg width="32" height="32" viewBox="0 0 32 32">
            <rect x="12" y="12" width="8" height="8" fill="black" />
            <line x1="16" y1="16" x2="16" y2="0" stroke="${lineColor}" stroke-width="2" />
          </svg>
        </div>
      `;
      return L.divIcon({
        className: '',
        html: html,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });
    }

    async function fetchFlightData() {
      try {
        const response = await fetch(url);
        const data = await response.json();
        const tbody = document.getElementById('flight-data');
        tbody.innerHTML = '';
        clearMarkers();

        if (!data.states || data.states.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10">Nenhum voo encontrado na √°rea.</td></tr>';
          return;
        }

        for (const state of data.states) {
          const [
            icao24, callsign, origin_country, time_position, last_contact,
            longitude, latitude, baro_altitude, on_ground, velocity,
            heading, vertical_rate, sensors, geo_altitude, squawk,
            spi, position_source
          ] = state;

          const flagHTML = await getFlagIcon(origin_country);

          const row = `
            <tr>
              <td>${icao24 || '‚Äî'}</td>
              <td>${callsign?.trim() || '‚Äî'}</td>
              <td>${flagHTML}</td>
              <td>${formatTime(time_position)}</td>
              <td>${formatTime(last_contact)}</td>
              <td>${baro_altitude?.toFixed(2) || '‚Äî'}</td>
              <td>${toKmh(velocity)}</td>
              <td>${toKmh(vertical_rate)}</td>
              <td>${formatTransponder(squawk)}</td>
              <td>${formatPositionSource(position_source)}</td>
            </tr>
          `;
          tbody.innerHTML += row;

          if (latitude && longitude) {
            const marker = L.marker([latitude, longitude], {
              icon: createDirectionIcon(heading, position_source)
            })
            .bindPopup(`
              <strong>Chamada:</strong> ${callsign?.trim() || '‚Äî'}<br>
              <strong>Pa√≠s de origem:</strong> ${origin_country}<br>
              <strong>Altitude barom√©trica:</strong> ${baro_altitude?.toFixed(0) || '‚Äî'} m<br>
              <strong>ICAO24:</strong> ${icao24 || '‚Äî'}<br>
              <strong>√öltima atualiza√ß√£o:</strong> ${formatTime(last_contact)}<br>
              <strong>Velocidade:</strong> ${toKmh(velocity)} km/h<br>
              <strong>Taxa vertical:</strong> ${toKmh(vertical_rate)} km/h<br>
              <strong>Transponder:</strong> ${formatTransponder(squawk)}<br>
              <strong>Fonte da posi√ß√£o:</strong> ${formatPositionSource(position_source)}
            `)
            .bindTooltip(callsign?.trim() || '‚Äî', {
              permanent: true,
              direction: 'top',
              offset: [0, -16],
              className: 'callsign-label'
            });

            marker.addTo(map);
            markers.push(marker);
          }
        }
      } catch (error) {
        document.getElementById('flight-data').innerHTML = '<tr><td colspan="13">Erro ao carregar dados.</td></tr>';
        console.error('Erro ao buscar dados da API:', error);
      }
    }

    initMap();
    fetchFlightData();
    setInterval(fetchFlightData, 60000);
  </script>
</body>
</html>
