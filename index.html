<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Voos em Tempo Real - Vila de Rei</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    .table-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    caption {
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    img.flag {
      width: 24px;
      height: 18px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="map"></div>
    <div class="table-container">
      <h2>Voos num raio alargado de Vila de Rei</h2>
      <p><em>Atualiza√ß√£o autom√°tica a cada 30 segundos</em></p>
      <table>
        <caption>Aeronaves Ativas</caption>
        <thead>
          <tr>
            <th>ICAO24</th>
            <th>Chamada</th>
            <th>Pa√≠s Origem</th>
            <th>√öltima Pos.</th>
            <th>√öltima Atual.</th>
            <th>Longitude</th>
            <th>Latitude</th>
            <th>Altitude Bar. (m)</th>
            <th>No Solo</th>
            <th>Velocidade (km/h)</th>
            <th>Taxa Vertical (km/h)</th>
            <th>Transponder</th>
            <th>Pos. Source</th>
          </tr>
        </thead>
        <tbody id="flight-data">
          <tr><td colspan="13">A carregar dados...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const url = "https://opensky-network.org/api/states/all?lamin=36.0&lamax=43.0&lomin=-11.5&lomax=-5.0";
    let map;
    let markers = [];

    function initMap() {
      map = L.map('map').setView([39.6761, -8.1272], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    async function getCountryCode(name) {
      try {
        const res = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fullText=true`);
        const data = await res.json();
        return data[0]?.cca2?.toLowerCase() || null;
      } catch {
        return null;
      }
    }

    async function getFlagIcon(countryName) {
      const code = await getCountryCode(countryName);
      if (!code) return `<span title="${countryName}">üåê</span>`;
      return `<img class="flag" src="https://flagcdn.com/24x18/${code}.png" alt="${countryName}" title="${countryName}">`;
    }

    function formatTime(ts) {
      return ts ? new Date(ts * 1000).toLocaleTimeString('pt-PT') : '‚Äî';
    }

    function toKmh(val) {
      return val != null ? (val * 3.6).toFixed(2) : '‚Äî';
    }

    function formatTransponder(code) {
      if (!code || typeof code !== 'string' || !/^[0-9]{4}$/.test(code)) return '‚Äî';
      const alerts = {
        "7500": "üî¥ Interfer√™ncia",
        "7600": "üü† Falha de r√°dio",
        "7700": "üü° Emerg√™ncia"
      };
      return alerts[code] ? `<span title="${alerts[code]}">${code}</span>` : code;
    }

    function formatPositionSource(code) {
      const sources = {
        0: "ADS-B",
        1: "ASTERIX",
        2: "MLAT"
      };
      return sources[code] ?? "‚Äî";
    }

    const createPlaneIcon = () => L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/3/3c/Red_triangle_pointed_up.svg',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16]
    });

    async function fetchFlightData() {
      try {
        const response = await fetch(url);
        const data = await response.json();
        const tbody = document.getElementById('flight-data');
        tbody.innerHTML = '';
        clearMarkers();

        if (!data.states || data.states.length === 0) {
          tbody.innerHTML = '<tr><td colspan="13">Nenhum voo encontrado na √°rea.</td></tr>';
          return;
        }

        for (const state of data.states) {
          const [
            icao24, callsign, origin_country, time_position, last_contact,
            longitude, latitude, baro_altitude, on_ground, velocity,
            heading, vertical_rate, , , , transponder_code, , position_source
          ] = state;

          const flagHTML = await getFlagIcon(origin_country);

          const row = `
            <tr>
              <td>${icao24 || '‚Äî'}</td>
              <td>${callsign?.trim() || '‚Äî'}</td>
              <td>${flagHTML}</td>
              <td>${formatTime(time_position)}</td>
              <td>${formatTime(last_contact)}</td>
              <td>${longitude?.toFixed(4) || '‚Äî'}</td>
              <td>${latitude?.toFixed(4) || '‚Äî'}</td>
              <td>${baro_altitude?.toFixed(2) || '‚Äî'}</td>
              <td>${on_ground}</td>
              <td>${toKmh(velocity)}</td>
              <td>${toKmh(vertical_rate)}</td>
              <td>${formatTransponder(transponder_code)}</td>
              <td>${formatPositionSource(position_source)}</td>
            </tr>
          `;
          tbody.innerHTML += row;

          if (latitude && longitude) {
            const marker = L.marker([latitude, longitude], {
              icon: createPlaneIcon(),
              rotationAngle: heading || 0,
              rotationOrigin: 'center center'
            }).bindPopup(`<strong>${callsign?.trim() || '‚Äî'}</strong><br>${origin_country}<br>Alt: ${baro_altitude?.toFixed(0) || '‚Äî'} m`);
            marker.addTo(map);
            markers.push(marker);
          }
        }
      } catch (error) {
        document.getElementById('flight-data').innerHTML = '<tr><td colspan="13">Erro ao carregar dados.</td></tr>';
        console.error('Erro ao buscar dados da API:', error);
      }
    }

    initMap();
    fetchFlightData();
    setInterval(fetchFlightData, 30000);
  </script>
</body>
</html>
