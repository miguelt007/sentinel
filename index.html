<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Voos em Tempo Real - Vila de Rei</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    caption {
      font-size: 1.5em;
      margin-bottom: 10px;
    }
    img.flag {
      width: 24px;
      height: 18px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <h1>Voos num raio de 200 km de Vila de Rei</h1>
  <p><em>Atualiza√ß√£o autom√°tica a cada 30 segundos</em></p>
  <table>
    <caption>Aeronaves Ativas</caption>
    <thead>
      <tr>
        <th>ICAO24</th>
        <th>Chamada</th>
        <th>Pa√≠s Origem</th>
        <th>√öltima Pos.</th>
        <th>√öltima Atual.</th>
        <th>Longitude</th>
        <th>Latitude</th>
        <th>Altitude Bar. (m)</th>
        <th>No Solo</th>
        <th>Velocidade (km/h)</th>
        <th>Taxa Vertical (km/h)</th>
        <th>Transponder</th>
        <th>Pos. Source</th>
      </tr>
    </thead>
    <tbody id="flight-data">
      <tr><td colspan="13">A carregar dados...</td></tr>
    </tbody>
  </table>

  <script>
    const url = "https://opensky-network.org/api/states/all?lamin=37.8761&lamax=41.4761&lomin=-10.3272&lomax=-5.9272";

    async function getCountryCode(name) {
      try {
        const res = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fullText=true`);
        const data = await res.json();
        return data[0]?.cca2?.toLowerCase() || null;
      } catch {
        return null;
      }
    }

    async function getFlagIcon(countryName) {
      const code = await getCountryCode(countryName);
      if (!code) return `<span title="${countryName}">üåê</span>`;
      return `<img class="flag" src="https://flagcdn.com/24x18/${code}.png" alt="${countryName}" title="${countryName}">`;
    }

    function formatTime(ts) {
      return ts ? new Date(ts * 1000).toLocaleTimeString('pt-PT') : '‚Äî';
    }

    function toKmh(val) {
      return val != null ? (val * 3.6).toFixed(2) : '‚Äî';
    }

    function formatTransponder(code) {
      if (!code || typeof code !== 'string' || !/^[0-9]{4}$/.test(code)) return '‚Äî';
      const alerts = {
        "7500": "üî¥ Interfer√™ncia",
        "7600": "üü† Falha de r√°dio",
        "7700": "üü° Emerg√™ncia"
      };
      return alerts[code] ? `<span title="${alerts[code]}">${code}</span>` : code;
    }

    async function fetchFlightData() {
      try {
        const response = await fetch(url);
        const data = await response.json();
        const tbody = document.getElementById('flight-data');
        tbody.innerHTML = '';

        if (!data.states || data.states.length === 0) {
          tbody.innerHTML = '<tr><td colspan="13">Nenhum voo encontrado na √°rea.</td></tr>';
          return;
        }

        for (const state of data.states) {
          const [
            icao24, callsign, origin_country, time_position, last_contact,
            longitude, latitude, baro_altitude, on_ground, velocity,
            vertical_rate, , , , transponder_code, , position_source
          ] = state;

          const flagHTML = await getFlagIcon(origin_country);

          const row = `
            <tr>
              <td>${icao24 || '‚Äî'}</td>
              <td>${callsign?.trim() || '‚Äî'}</td>
              <td>${flagHTML}</td>
              <td>${formatTime(time_position)}</td>
              <td>${formatTime(last_contact)}</td>
              <td>${longitude?.toFixed(4) || '‚Äî'}</td>
              <td>${latitude?.toFixed(4) || '‚Äî'}</td>
              <td>${baro_altitude?.toFixed(2) || '‚Äî'}</td>
              <td>${on_ground}</td>
              <td>${toKmh(velocity)}</td>
              <td>${toKmh(vertical_rate)}</td>
              <td>${formatTransponder(transponder_code)}</td>
              <td>${position_source}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        }
      } catch (error) {
        document.getElementById('flight-data').innerHTML = '<tr><td colspan="13">Erro ao carregar dados.</td></tr>';
        console.error('Erro ao buscar dados da API:', error);
      }
    }

    fetchFlightData();
    setInterval(fetchFlightData, 30000);
  </script>
</body>
</html>
